{% from "macros/card_content_display.html" import render_card_content with context %}

<div class="space-y-4">
    <div class="flex justify-between items-center mb-6">
        <div class="flex items-center space-x-4">
            <div class="flex rounded-lg shadow-sm bg-gray-100 p-1">
                <button onclick="setViewMode('list')" id="listViewBtn" class="view-tab active px-4 py-2 text-sm font-medium rounded-md flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
                    </svg>
                    <span>List</span>
                </button>
                <button onclick="setViewMode('grid')" id="gridViewBtn" class="view-tab px-4 py-2 text-sm font-medium rounded-md flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                    </svg>
                    <span>Grid</span>
                </button>
            </div>
            
            <!-- Grid size controls (only visible in grid mode) -->
            <div id="gridControls" class="hidden items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <label for="gridRows" class="text-sm text-gray-600">Rows:</label>
                    <select id="gridRows" onchange="updateGridSize()" class="border rounded px-2 py-1 text-sm">
                        {% for n in [2, 3, 4, 5] %}
                        <option value="{{ n }}" {% if grid_rows == n %}selected{% endif %}>{{ n }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="flex items-center space-x-2">
                    <label for="gridCols" class="text-sm text-gray-600">Columns:</label>
                    <select id="gridCols" onchange="updateGridSize()" class="border rounded px-2 py-1 text-sm">
                        {% for n in [2, 3, 4, 5] %}
                        <option value="{{ n }}" {% if grid_cols == n %}selected{% endif %}>{{ n }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Items per page selector -->
        <div class="flex items-center space-x-2">
            <span class="text-sm text-gray-600">Items per page:</span>
            <select onchange="updatePerPage(this.value)" class="border rounded px-2 py-1 text-sm">
                {% for n in [10, 20, 30, 40, 50] %}
                <option value="{{ n }}" {% if pagination.per_page == n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div id="cardContainer" class="transition-all duration-300">
        <div class="cards-container {% if view_mode == 'grid' %}grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6{% endif %}">
            {% for card in cards %}
                <div class="transform transition-all duration-200 hover:-translate-y-1 hover:shadow-lg">
                    <div class="bg-white rounded-lg shadow {% if view_mode == 'list' %}p-4 mb-4{% else %}p-6{% endif %}">
                        <div class="space-y-4">
                            <div class="flex items-start justify-between">
                                <div class="space-y-1">
                                    <p class="text-sm font-medium text-gray-500">Hash</p>
                                    <p class="font-mono text-sm text-gray-900">{{ card.hash[:12] }}...</p>
                                </div>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{ 'bg-blue-100 text-blue-800' if card.content_type == 'text' else 'bg-green-100 text-green-800' }}">
                                    {{ card.content_type }}
                                    {% if card.is_image %}(Image){% endif %}
                                </span>
                            </div>

                            <div class="content-preview rounded-md bg-gray-50 p-4">
                                {{ render_card_content(card, preview_mode=true, view_mode=view_mode) }}
                            </div>

                            <div class="flex items-center justify-between pt-4">
                                <div class="text-sm text-gray-500">
                                    {{ card.content|length }} bytes
                                </div>
                                <div class="flex space-x-3">
                                    <a href="{{ url_for('card_detail', card_hash=card.hash) }}" 
                                       class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-primary hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors">
                                        View
                                    </a>
                                    <button onclick="deleteCard('{{ card.hash }}', event)"
                                            class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Pagination controls -->
{% if pagination.total_pages > 1 %}
<div class="mt-6 flex items-center justify-between border-t pt-4">
    <div class="text-sm text-gray-500">
        Showing {{ (pagination.page - 1) * pagination.per_page + 1 }} to 
        {{ (pagination.page * pagination.per_page)|min(pagination.total_cards) }} 
        of {{ pagination.total_cards }} items
    </div>
    <div class="flex space-x-2">
        {% if pagination.has_prev %}
        <a href="{{ url_for('index', page=pagination.page-1, per_page=pagination.per_page) }}"
           class="px-3 py-1 border rounded text-sm hover:bg-gray-50">Previous</a>
        {% endif %}
        
        {% for p in range(1, pagination.total_pages + 1) %}
            {% if p == pagination.page %}
            <span class="px-3 py-1 bg-blue-50 border border-blue-500 rounded text-sm text-blue-600">{{ p }}</span>
            {% else %}
            <a href="{{ url_for('index', page=p, per_page=pagination.per_page) }}"
               class="px-3 py-1 border rounded text-sm hover:bg-gray-50">{{ p }}</a>
            {% endif %}
        {% endfor %}
        
        {% if pagination.has_next %}
        <a href="{{ url_for('index', page=pagination.page+1, per_page=pagination.per_page) }}"
           class="px-3 py-1 border rounded text-sm hover:bg-gray-50">Next</a>
        {% endif %}
    </div>
</div>
{% endif %}

<style>
    /* Grid mode */
    #cardContainer.grid-mode .cards-container {
        display: grid;
        grid-template-columns: repeat({{ grid_cols }}, 1fr);
        gap: 1.5rem;
    }

    @media (max-width: 640px) {
        #cardContainer.grid-mode .cards-container {
            grid-template-columns: repeat(1, 1fr);
        }
    }

    @media (min-width: 641px) and (max-width: 1024px) {
        #cardContainer.grid-mode .cards-container {
            grid-template-columns: repeat({{ grid_cols|min(2) }}, 1fr);
        }
    }

    /* List mode */
    #cardContainer.list-mode .cards-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .content-preview {
        max-height: 200px;
        overflow-y: auto;
    }

    .content-preview pre {
        @apply text-sm font-mono;
    }

    .content-preview img {
        @apply max-h-32 mx-auto;
    }

    .view-tab {
        @apply text-gray-500 transition-all duration-200;
    }

    .view-tab:hover {
        @apply text-gray-700;
    }

    .view-tab.active {
        @apply bg-white text-gray-900 shadow;
    }
</style>

<script>
    // Initialize view mode on page load
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('cardContainer');
        const gridControls = document.getElementById('gridControls');
        const savedMode = localStorage.getItem('cardViewMode') || 'list';
        
        // Set initial mode
        setViewMode(savedMode);
    });

    function setViewMode(mode) {
        const container = document.getElementById('cardContainer');
        const listBtn = document.getElementById('listViewBtn');
        const gridBtn = document.getElementById('gridViewBtn');
        const gridControls = document.getElementById('gridControls');
        
        // Remove both modes first
        container.classList.remove('list-mode', 'grid-mode');
        
        // Add the selected mode
        container.classList.add(mode + '-mode');
        
        // Update buttons
        if (mode === 'grid') {
            gridBtn.classList.add('active');
            listBtn.classList.remove('active');
            gridControls.classList.remove('hidden');
            gridControls.classList.add('flex');
        } else {
            listBtn.classList.add('active');
            gridBtn.classList.remove('active');
            gridControls.classList.remove('flex');
            gridControls.classList.add('hidden');
        }
        
        // Save preference
        localStorage.setItem('cardViewMode', mode);
    }

    function updateGridSize() {
        const rows = document.getElementById('gridRows').value;
        const cols = document.getElementById('gridCols').value;
        window.location.href = `{{ url_for('index') }}?page={{ pagination.page }}&per_page={{ pagination.per_page }}&grid_rows=${rows}&grid_cols=${cols}`;
    }

    function updatePerPage(perPage) {
        window.location.href = `{{ url_for('index') }}?page=1&per_page=${perPage}`;
    }

    function deleteCard(hash, event) {
        if (confirm('Are you sure you want to delete this card?')) {
            fetch(`/cards/${hash}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    const card = event.target.closest('.transform');
                    card.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => card.remove(), 300);
                    showFlash('Card deleted successfully', 'success');
                } else {
                    showFlash('Failed to delete card', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showFlash('Failed to delete card', 'error');
            });
        }
    }

    function showFlash(message, type) {
        const flash = document.createElement('div');
        flash.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white transform transition-all duration-300 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
        flash.textContent = message;
        document.body.appendChild(flash);
        
        // Animate in
        setTimeout(() => flash.classList.add('translate-y-2'), 0);
        
        // Animate out and remove
        setTimeout(() => {
            flash.classList.add('opacity-0', '-translate-y-2');
            setTimeout(() => flash.remove(), 300);
        }, 2700);
    }
</script>
